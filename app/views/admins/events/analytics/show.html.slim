- content_for(:javascripts) do
  = javascript_include_tag 'specific/pivot_tables'

- content_for(:title) do
  | Analytics

.mdl-grid.light-grid
  .mdl-layout-spacer
  .mdl-cell.mdl-cell--12-col
    .transaction-card-wide.mdl-card.mdl-shadow--2dp
      .mdl-tabs.mdl-js-tabs.mdl-js-ripple-effect
        .mdl-tabs__tab-bar.analytics-card-back
          = link_to "Dashboard", "#dashboard-panel", class: "mdl-tabs__tab is-active"
          = link_to key_metrics_admins_event_analytics_path(@current_event), remote: true, class: "mdl-tabs__tab" do
            | Key Metrics
            span.mdl-tabs__ripple-container.mdl-js-ripple-effect
              span.mdl-ripple
          = link_to sales_admins_event_analytics_path(@current_event), remote: true, class: "mdl-tabs__tab" do
            | Sales
            span.mdl-tabs__ripple-container.mdl-js-ripple-effect
              span.mdl-ripple
          = link_to gates_admins_event_analytics_path(@current_event), remote: true, class: "mdl-tabs__tab" do
            | Gates
            span.mdl-tabs__ripple-container.mdl-js-ripple-effect
              span.mdl-ripple
          = link_to partner_reports_admins_event_analytics_path(@current_event), remote: true, class: "mdl-tabs__tab" do
            | Partner Reports
            span.mdl-tabs__ripple-container.mdl-js-ripple-effect
              span.mdl-ripple
          .fake_tab#export-pdf title='Download PDF' onClick="downloadPDF($('.mdl-tabs__tab.is-active').text())"
            i.material-icons#downloadIcon file_download

        #dashboard-panel.mdl-tabs__panel.is-active
          .mdl-grid
            .mdl-layout-spacer
            .mdl-cell.mdl-cell--10-col
              .mld-card
                .content-grid.mdl-grid
                  .mdl-cell.mdl-cell--12-col.no-wrapper-style.margin-auto
                    - dashboard_data = analytics_cards(@current_event, :dashboard)
                    .mdl-grid.no-wrapper-style.padding
                      = render "new_card", card: dashboard_data[:topups], cols: 3, custom_class: 'hovering'
                      = render "new_card", card: dashboard_data[:sales], cols: 3, custom_class: 'hovering'
                      = render "new_card", card: dashboard_data[:products], cols: 3, custom_class: 'hovering'
                      = render "new_card", card: dashboard_data[:activations], cols: 3, custom_class: 'hovering'
                  .mdl-cell.mdl-cell--12-col.no-wrapper-style.margin-auto
                    .mdl-grid.no-wrapper-style.padding
                      = render "bar_card", card: dashboard_data[:tickets_and_orders], cols: 6
                      = render "new_card", card: dashboard_data[:gtags], cols: 3, custom_class: 'hovering'
                      = render "new_card", card: dashboard_data[:customers], cols: 3, custom_class: 'hovering'

              .mld-card
                .content-grid.mdl-grid
                  .mdl-cell.mdl-cell--12-col.no-wrapper-style.margin-auto
                    .mdl-grid.no-wrapper-style.padding
                      .mdl-cell.analytics-card-back.mdl-cell--6-col
                        .mdl-cell.mdl-cell--12-col
                          canvas#top_products
                      .mdl-cell.analytics-card-back.mdl-cell--6-col
                        .mdl-cell.mdl-cell--12-col
                          canvas#alcohol_products
            .mdl-layout-spacer
        #load-view
      .mdl-layout-spacer

      - if @message
        .mdl-cell.mdl-cell--12-col
          .center-card-title
            span.analytics-text = @message

javascript:
  $(window).load(function(e) {
    $(".is-active").click();
  });

  $(document).ready(function() {
    $(".mdl-tabs__tab").click(function(e) {
      var elem = e.currentTarget;
      var elems = $(".mdl-tabs__tab");
      elems.splice($.inArray(elem, elems), 1);
      elems.removeClass("is-active");
      elem.text == 'Dashboard' ? $('#load-view').hide() : $('#load-view').show();
      $(elem).addClass("is-active");
    });

  });

  function downloadPDF(previousName) {
    var eventData = JSON.parse("#{escape_javascript(@current_event.attributes.slice("name", "start_date", "end_date", "support_email").merge({logo_url: @current_event.logo.url(:panel)}).to_json.html_safe)}");
    canvasToPDF($('.mdl-tabs__panel.is-active'), previousName, eventData);
  }

  function gradientSector(ctx, colors) {
    var gradient = ctx.createLinearGradient(0, 200, 100, 20);
    gradient.addColorStop(0, colors[0]);
    gradient.addColorStop(1, colors[1]);
    return gradient
  }

  var data =#{ @totals[:totals_pokes][:event_day_money].html_safe }
  var credit_symbol = '#{ @current_event.credit.symbol }'
  var color_scale_a = [["#11998E", "#38EF7D"], ["#74EBD5", "#ACB6E5"]]
  var data_a = #{ @totals[:totals_pokes][:alcohol_products].html_safe }
  var is_alcohol = data_a.map(function (e) { return e.is_alcohol });
  var credits = data_a.map(function (e) { return e.credits });
  var ctx_alcohol = document.getElementById("alcohol_products").getContext('2d');

  new Chart(ctx_alcohol, {
    type: 'doughnut',
    data: {
      labels: is_alcohol,
      datasets: [
        {
          label: "Product" + credit_symbol,
          data: credits,
          backgroundColor: color_scale_a.map(function(colors) {return gradientSector(ctx_alcohol, colors)}),
          hoverBackgroundColor: color_scale_a.map(function(colors) {return gradientSector(ctx_alcohol, colors)}),
          hoverBorderWidth: 2,
					hoverBorderColor: '#CCCCCC'
        }
      ]
    },
    options: {
      title: {
        display: true,
        text: 'Alcohol Products vs Non Alcohol'
      },
      tooltips: {
        custom: function(tooltip) {
          if (!tooltip) return;
          tooltip.displayColors = false;
        },
        callbacks: {
          title: function(tooltipItem, data) {
            return [data.labels[tooltipItem[0].index]]
          },
          label: function(tooltipItem, data) {
            return [
              "Credits: " + data.datasets[0].data[tooltipItem.index] + " " + "#{@event_currency}",
              "Amount: " + data_a[tooltipItem.index].credits_amount,
            ]
          }
        }
      },
    }
  });

  var color_scale_p = [["#36D1DC", "#5B86E5"], ["#CAC531", "#F3F9A7"], ["#BC4E9C", "#F80759"], ["#00F260", "#0575E6"], ["#834D9B", "#D04ED6"], ["#11998E", "#38EF7D"], ["#4DA0B0", "#D39D38"], ["#EECDA3", "#EF629F"], ["#FC4A1A", "#F7B733"], ["#FF5F6B", "#FFC371"]];
  var data_p = #{@totals[:totals_pokes][:top_products].html_safe}
  var product_name = data_p.map(function (e) { return e.product_name });
  var credits = data_p.map(function (e) { return e.credits });
  var ctx_products = document.getElementById("top_products").getContext('2d');

  new Chart(ctx_products, {
    type: 'doughnut',
    data: {
      labels: product_name,
      datasets: [
        {
          label: "Product" + credit_symbol,
          data: credits,
          backgroundColor: color_scale_p.map(function(colors) {return gradientSector(ctx_products, colors)}),
          hoverBackgroundColor: color_scale_p.map(function(colors) {return gradientSector(ctx_products, colors)}),
          hoverBorderWidth: 2,
					hoverBorderColor: '#CCCCCC'
        }
      ]
    },
    options: {
      title: {
        display: true,
        text: "Top " + product_name.length + " products " + credit_symbol
      },
      tooltips: {
        custom: function(tooltip) {
          if (!tooltip) return;
          tooltip.displayColors = false;
        },
        callbacks: {
          title: function(tooltipItem, data) {
            return [data.labels[tooltipItem[0].index]]
          },
          label: function(tooltipItem, data) {
            return [
              "Credits: " + data.datasets[0].data[tooltipItem.index] + " " + "#{@event_currency}",
            ]
          }
        }
      },
    }
  });
